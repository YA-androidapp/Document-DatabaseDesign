# デザインパターン・アンチパターン

---

テーブル設計で起こりがちなアンチパターンを列挙する。いついかなる時も厳禁というものではなく、パフォーマンスなどとのトレードオフを考慮して修正するかそのまま保持するか都度検討する。

---

# 命名規則

## 複合語の表記（キャピタライゼーション）

大文字小文字を区別しない（case insensitive）環境で語句を判別できない事態を防ぐために、小文字のみでも単語の切れ目が明確なものを利用する。

| 名称                                               | 表記例               |      |
| -------------------------------------------------- | -------------------- | ---- |
| キャメルケース                                     | camelCase            |      |
| パスカルケース ／ アッパーキャメルケース           | PascalCase           |      |
| スネークケース ／ ポットホールケース               | snake_case           | o    |
| コンスタントケース ／ スクリーミングスネークケース | CONSTANT_CASE        | 定数 |
| ケバブケース ／ チェインケース                     | kebab-case           | o    |
| スクリーミングケバブケース                         | SCREAMING-KEBAB-CASE |      |
| トレインケース                                     | Train-Case           |      |
|                                                    |                      |      |

## 全般

| 内容                                                     | x         | o                     |
| -------------------------------------------------------- | --------- | --------------------- |
| 日本語のローマ字表記を使用せず、英単語を使用する         | `namae`   | `name`                |
| 単語を省略しない                                         | `flg`     | `flag`                |
|                                                          | `cd`      | `code`                |
| 意味の広い単語を使用しない                               | `data`    |                       |
|                                                          | `helper`  |                       |
|                                                          | `info`    |                       |
|                                                          | `list`    |                       |
|                                                          | `manager` |                       |
|                                                          | `temp`    |                       |
|                                                          | `utility` |                       |
|                                                          |           |                       |
| 主キー名を `id` にしない（テーブル毎にきちんと名付ける） | `id`      | `post_id` `author_id` |
|                                                          |           |                       |
|                                                          |           |                       |

# テーブル設計

## テーブル

### マスタ・トランザクション

マスタデータを格納するテーブルと、トランザクションデータを格納するテーブルは分けて考える。

### テーブル名

| 項目                                              | 内容                                                                                             |
| ------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| 年（年月）を含むテーブル名→水平パーティショニング | 年ごとにレコードを格納する先のテーブルを変更するのではなく、同一テーブルでパーティショニングする |
|                                                   |                                                                                                  |

### テーブル分割

| 項目                       | 内容                                                     |
| -------------------------- | -------------------------------------------------------- |
| 垂直分割                   | サイズが大きい文字列型、BLOB型の列を別テーブルに分割する |
|                            | 参照頻度が低い列を別テーブルに分割する                   |
| 水平分割（シャーディング） | 除算による余りを利用して、格納する先のテーブルを分ける   |
|                            |                                                          |

### 履歴テーブル

テーブルにレコードの履歴を残すことで、以下の状況を防ぐ。

- レコードの値が変更された推移がわからない
  - 承認ステータスが「下書き」→「申請済」→「1次承認済」→「2次承認済」→「3次承認済」→「完了」と変わったのか、「申請済」→「引き上げ承認」→「完了」と変わったのか区別できない
- マスタが更新されて計算が合わない
  - 消費税率の変更前後で合計金額が合わない
  - 計算の途中経過がわからない
  - 過去の取引金額が変わってしまう

## 列

### 列のデータ型

| 分類         | 項目                                                       | 内容                                                                     |
| ------------ | ---------------------------------------------------------- | ------------------------------------------------------------------------ |
| データ型     | 数値文字列（電話番号、郵便番号、各種コード）               | ゼロ欠けを防ぐために、数値型ではなく文字列型を使う                       |
| リレーション | ＊SV形式（カンマやタブなどの区切り文字で区切られた文字列） | 文字列型の単一列に格納するのではなく、一対多／多対多のリレーションを張る |
| リレーション | 親子関係を表現するために、親のIDを子のレコードに格納する   | 閉包テーブルを使う                                                       |
|              |                                                            |                                                                          |

### 列の制約

#### NULL

| 項目                         | 内容                                                                                                           |
| ---------------------------- | -------------------------------------------------------------------------------------------------------------- |
| 必要以上に NULL を許容しない | レコード（オブジェクト）に含まれる一部の属性の情報が不足していてもレコード登録できるようにすべきかよく検討する |
|                              | NULL とその他の値で扱いが異なる場合の複雑さを回避するために、なるべく非 NULL 制約を設定する                    |
|                              |                                                                                                                |

#### UNIQUE

| 項目                       | 内容                                                                                                         |
| -------------------------- | ------------------------------------------------------------------------------------------------------------ |
| なるべく一意制約を設定する | 業務要件としてデータの重複が発生しないことが明らかな場合は、アプリケーション側ではなく DB 側で制約を設定する |
|                            |                                                                                                              |

#### 文字長

氏名や住所といった項目について、実例から最大長を求めようとする例が多々あるが、今後それらよりも長い文字列が出現する可能性があるので一旦決め打ちとする。※の項目は、 [Azure AD（Entra ID）](https://learn.microsoft.com/ja-jp/powershell/module/az.resources/new-azaduser?view=azps-10.3.0) の制約を参考にした。

| 項目             | 最大長 | 根拠                                                                                                |
| ---------------- | ------ | --------------------------------------------------------------------------------------------------- |
| 姓               | 64     | A                                                                                                   |
| 名               | 64     | A                                                                                                   |
|                  |        |                                                                                                     |
| 氏名             | 256    | A                                                                                                   |
|                  |        |                                                                                                     |
| 法人名           | 64     | A                                                                                                   |
|                  |        |                                                                                                     |
| メールアドレス   | 254    | RFC 2821                                                                                            |
|                  |        | 区切り文字（ `<` `>` を含めて256文字が上限）                                                        |
|                  | 320    | RFC 3696、RFC 5321                                                                                  |
|                  |        | ローカル部（@より前）の最大長は64文字                                                               |
|                  |        | ドメイン部（@より後）の最大長は255文字                                                              |
|                  |        | ただし、DNSで名前解決をする必要があるため、DNS側の仕様による制約を受け、ドメイン部の最大長は253文字 |
|                  |        |                                                                                                     |
| 電話番号         |        | ITU-T(国際電気通信連合 電気通信標準化セクター) E.164勧告                                            |
|                  | 19     | （国番号含め最大15桁 + `+` + `-` 3 つ）                                                             |
|                  | 15     | （国番号含め最大15桁）                                                                              |
|                  |        |                                                                                                     |
| 郵便番号（日本） | 7      | ハイフン無                                                                                          |
|                  | 8      | ハイフン有                                                                                          |
|                  |        |                                                                                                     |
| 住所             | 1408   | country（128） + state（128） + city（128） + streetAddress（1024）                                 |
|                  |        |                                                                                                     |
| URL              | 8000   | RFC 7230                                                                                            |
|                  |        |                                                                                                     |

#### コード定義

コード値が規格で定められているものについては、それを使用する。

| 項目                              | コード  | 意味            | 根拠                                                                                                 |
| --------------------------------- | ------- | --------------- | ---------------------------------------------------------------------------------------------------- |
| 生物学的性別（GenderではなくSex） |         |                 | ISO 5218                                                                                             |
|                                   | `0`     | not known       |                                                                                                      |
|                                   | `1`     | male            |                                                                                                      |
|                                   | `2`     | female          |                                                                                                      |
|                                   | `9`     | not applicable  |                                                                                                      |
|                                   |         |                 |                                                                                                      |
| 国（国名コード）                  |         |                 | ISO 3166-1                                                                                           |
|                                   | `392`   | 日本（numeric） |                                                                                                      |
|                                   | `JPN`   | 日本（alpha-3） |                                                                                                      |
|                                   | `JP`    | 日本（alpha-2） |                                                                                                      |
|                                   |         |                 |                                                                                                      |
| 言語（言語コード）                |         |                 |                                                                                                      |
|                                   | `ja`    | 日本語          | ISO 639                                                                                              |
|                                   | `ja-JP` | 日本語 (日本)   | IETF言語タグ IETF BCP47（RFC 5646、RFC 4647）                                                        |
|                                   |         |                 | [IETF BCP47](https://www.rfc-editor.org/rfc/bcp/bcp47.txt)                                           |
|                                   |         |                 |                                                                                                      |
| 都道府県・市区町村                |         |                 | 全国地方公共団体コード                                                                               |
|                                   |         |                 | [総務省｜地方行政のデジタル化｜全国地方公共団体コード](https://www.soumu.go.jp/denshijiti/code.html) |
|                                   |         |                 |                                                                                                      |

#### コード以外の定義

| 項目         | 内容 | 根拠                                                                                                      |
| ------------ | ---- | --------------------------------------------------------------------------------------------------------- |
| 郵便番号     |      | [郵便番号データダウンロード - 日本郵便](https://www.post.japanpost.jp/zipcode/download.html)              |
|              |      |                                                                                                           |
| 電話番号     |      | [電気通信番号指定状況](https://www.soumu.go.jp/main_sosiki/joho_tsusin/top/tel_number/number_shitei.html) |
| （固定電話） |      |                                                                                                           |
| （携帯電話） |      |                                                                                                           |
|              |      |                                                                                                           |

#### スマートカラム／有意コード／暗黙的な制約

部門コードの先頭が0の場合は本部を表す、ユーザーIDの先頭が0の場合は管理者を表す、というように、
列のデータへ暗黙的に意味を持たせることは避ける（列を分割する）。

### 列名

| データ型 | 内容                                                     | x               | o             |
| -------- | -------------------------------------------------------- | --------------- | ------------- |
| Boolean  | True / Falseがどちらの状態を表すのか明確にする           | `delete_flag`   | `is_deleted`  |
|          | ブール値ではなく日時型列の NULL / 非 NULL をフラグとする |                 | `deleted_on`  |
| Date     | 過去分詞_on                                              | `creation_date` | `created_on`  |
| DateTime | 過去分詞_at                                              |                 | `updated_on`  |
| Time     | 過去分詞_at                                              |                 | `modified_on` |
|          |                                                          |                 |               |

### 予備カラム

将来的な機能拡張に備えた予備カラムは作らない。

### 列持ち→行持ち

列を増減させることが難しく、アプリケーション側で都度NULLチェックする必要があるため、列持ち（横持ち）は避けて行持ち（縦持ち）の構造としたほうが良い。

| 社員 | 資格1        | 資格2                      | 資格3    |
| ---- | ------------ | -------------------------- | -------- |
| 江崎 | ITパスポート | 基本情報                   | 応用情報 |
| 望月 | 基本情報     | クラウドプラクティショナー |          |
|      |              |                            |          |

　　　↓

| 社員 | 資格コード |
| ---- | ---------- |
| 江崎 | 001        |
| 江崎 | 002        |
| 江崎 | 003        |
| 望月 | 002        |
| 望月 | 100        |
|      |            |

| 資格コード | 資格名                     |
| ---------- | -------------------------- |
| 001        | ITパスポート               |
| 002        | 基本情報                   |
| 003        | 応用情報                   |
| 100        | クラウドプラクティショナー |
|            |                            |

### 単一参照テーブル（One True Lookup Table）／EAV（Entity Attribute Value）

データ型やサイズなどの制約チェックができないので、列持ちに直す（シングルテーブル継承）か、テーブルを分割する（具象テーブル継承）。テーブルを分割する際に、都道府県マスタと市区町村マスタのように、ほぼ共通の列で一部だけ異なる列が含まれるような組み合わせの場合は、2テーブルではなく、継承元のテーブル1つ＋継承先のテーブル2つとすることも可能（クラステーブル継承）。

| マスタ種別 | 設定キー       | 設定値                        |
| ---------- | -------------- | ----------------------------- |
| 顧客マスタ | 顧客コード     | 001                           |
| 顧客マスタ | 顧客名         | コントソ株式会社              |
| 顧客マスタ | 連絡先電話番号 | 03-0123-4567                  |
| 顧客マスタ | URL            | https://contoso.example.net/  |
| 顧客マスタ | 顧客コード     | 002                           |
| 顧客マスタ | 顧客名         | 株式会社ファブリカム          |
| 顧客マスタ | 連絡先電話番号 | 0120-000-000                  |
| 顧客マスタ | URL            | https://fabrikam.example.net/ |
| ...        |                |                               |
| 役職マスタ | 役職コード     | 001                           |
| 役職マスタ | 役職名         | 社長                          |
| 役職マスタ | 上位役職コード | NULL                          |
| 役職マスタ | 役職コード     | 002                           |
| 役職マスタ | 役職名         | 副社長                        |
| 役職マスタ | 上位役職コード | 001                           |
| ...        |                |                               |
|            |                |                               |

　　　↓

| マスタ種別 | 顧客コード | 顧客名               | 連絡先電話番号 | URL                           | 役職コード | 役職名 | 上位役職コード |
| ---------- | ---------- | -------------------- | -------------- | ----------------------------- | ---------- | ------ | -------------- |
| 顧客マスタ | 001        | コントソ株式会社     | 03-0123-4567   | ttps://contoso.example.net/   | NULL       | NULL   | NULL           |
| 顧客マスタ | 002        | 株式会社ファブリカム | 0120-000-000   | https://fabrikam.example.net/ | NULL       | NULL   | NULL           |
| ...        |            |                      |                |                               |            |        |                |
| 役職マスタ | NULL       | NULL                 | NULL           | NULL                          | 001        | 社長   | NULL           |
| 役職マスタ | NULL       | NULL                 | NULL           | NULL                          | 002        | 副社長 | 001            |
| ...        |            |                      |                |                               |            |        |                |

　　　↓

| 顧客コード | 顧客名               | 連絡先電話番号 | URL                           |
| ---------- | -------------------- | -------------- | ----------------------------- |
| 001        | コントソ株式会社     | 03-0123-4567   | ttps://contoso.example.net/   |
| 002        | 株式会社ファブリカム | 0120-000-000   | https://fabrikam.example.net/ |
| ...        |                      |                |                               |

| 役職コード | 役職名 | 上位役職コード |
| ---------- | ------ | -------------- |
| 001        | 社長   | NULL           |
| 002        | 副社長 | 001            |
| ...        |        |                |

### ポリモーフィック関連

子エンティティが、複数の親エンティティを参照するものをポリモーフィック関連と呼ぶ。
テーブルのリレーションでは1つの親テーブルしか関連付けられないため、子テーブル側に、親テーブルの名称（またはコード）と親レコードのIDを格納する2列を持たせる。

| post_id  | title                       | genre_id | content                                                   |
| -------- | --------------------------- | -------- | --------------------------------------------------------- |
| 00000001 | Lorem ipsum dolor sit amet  | 00001234 | Aenean imperdiet laoreet tincidunt.                       |
| 00000002 | Consectetur adipiscing elit | 00002345 | Aliquam dignissim gravida est, quis auctor dui tempus eu. |
|          |                             |          |                                                           |

| news_id  | title                 | summary                                | content                                         |
| -------- | --------------------- | -------------------------------------- | ----------------------------------------------- |
| 00000001 | Curabitur in ornare   | Vestibulum pulvinar a nisi et aliquet. | Vestibulum convallis, dolor vel iaculis tempus. |
| 00000002 | Nam lobortis sed orci | Justo ligula eleifend nulla.           | Sit amet varius urna odio vel mauris.           |
|          |                       |                                        |                                                 |

| comment_id | comment_type | id       | content                                       |
| ---------- | ------------ | -------- | --------------------------------------------- |
| 00000001   | Posts        | 00000001 | Justo ligula eleifend nulla.                  |
| 00000002   | News         | 00000001 | Cras rutrum aliquet lectus id convallis.      |
| 00000003   | News         | 00000002 | Fusce tortor orci, volutpat vel augue rutrum. |
|            |              |          |                                               |

ただし、外部キー制約を設定できないデメリットがあるため、以下の構造とすることも可能。

- 親テーブル同士の共通テーブルを追加
- 子テーブルを分割
- 子テーブルの列を親テーブルに統合
- 中間テーブルを追加

---

Copyright (c) 2023 YA-androidapp(https://github.com/yzkn) All rights reserved.
