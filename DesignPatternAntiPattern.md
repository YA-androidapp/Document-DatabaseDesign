# デザインパターン・アンチパターン

---

テーブル設計で起こりがちなアンチパターンを列挙する。いついかなる時も厳禁というものではなく、パフォーマンスなどとのトレードオフを考慮して修正するかそのまま保持するか都度検討する。

---

# 複合語の表記（キャピタライゼーション）

大文字小文字を区別しない（case insensitive）環境で語句を判別できない事態を防ぐために、小文字のみでも単語の切れ目が明確なものを利用する。

| 名称                                               | 表記例               |      |
| -------------------------------------------------- | -------------------- | ---- |
| キャメルケース                                     | camelCase            |      |
| パスカルケース ／ アッパーキャメルケース           | PascalCase           |      |
| スネークケース ／ ポットホールケース               | snake_case           | o    |
| コンスタントケース ／ スクリーミングスネークケース | CONSTANT_CASE        | 定数 |
| ケバブケース ／ チェインケース                     | kebab-case           | o    |
| スクリーミングケバブケース                         | SCREAMING-KEBAB-CASE |      |
| トレインケース                                     | Train-Case           |      |
|                                                    |                      |      |

---

# 命名規則

## 全般

| 内容                                                     | x         | o                     |
| -------------------------------------------------------- | --------- | --------------------- |
| 日本語のローマ字表記を使用せず、英単語を使用する         | `namae`   | `name`                |
| 単語を省略しない                                         | `flg`     | `flag`                |
|                                                          | `cd`      | `code`                |
| 意味の広い単語を使用しない                               | `data`    |                       |
|                                                          | `helper`  |                       |
|                                                          | `info`    |                       |
|                                                          | `list`    |                       |
|                                                          | `manager` |                       |
|                                                          | `temp`    |                       |
|                                                          | `utility` |                       |
|                                                          |           |                       |
| 主キー名を `id` にしない（テーブル毎にきちんと名付ける） | `id`      | `post_id` `author_id` |
|                                                          |           |                       |
|                                                          |           |                       |

## テーブル

### テーブル名

| 分類 | 項目                       | 内容                                                                                   |
| ---- | -------------------------- | -------------------------------------------------------------------------------------- |
| 分割 | 垂直分割                   |                                                                                        |
| 分割 | 年（年月）を含むテーブル名 | 年ごとにレコードを格納する先を変更するのではなく、同一テーブルでパーティショニングする |

## 列

### 列のデータ型

| 分類         | 項目                                                       | 内容                                                                     |
| ------------ | ---------------------------------------------------------- | ------------------------------------------------------------------------ |
| データ型     | 数値文字列（電話番号、郵便番号、各種コード）               | ゼロ欠けを防ぐために、数値型ではなく文字列型を使う                       |
| リレーション | ＊SV形式（カンマやタブなどの区切り文字で区切られた文字列） | 文字列型の単一列に格納するのではなく、一対多／多対多のリレーションを張る |
| リレーション | 親子関係を表現するために、親のIDを子のレコードに格納する   | 閉包テーブルを使う                                                       |
|              |                                                            |                                                                          |
|              |                                                            |                                                                          |
|              |                                                            |                                                                          |
|              |                                                            |                                                                          |
|              |                                                            |                                                                          |
|              |                                                            |                                                                          |

### 列の制約

#### 文字長

氏名や住所といった項目について、実例から最大長を求めようとする例が多々あるが、今後それらよりも長い文字列が出現する可能性があるので一旦決め打ちとする。※の項目は、 [Azure AD（Entra ID）](https://learn.microsoft.com/ja-jp/powershell/module/az.resources/new-azaduser?view=azps-10.3.0) の制約を参考にした。

| 項目             | 最大長 | 根拠                                                                                                |
| ---------------- | ------ | --------------------------------------------------------------------------------------------------- |
| 姓               | 64     | A                                                                                                   |
| 名               | 64     | A                                                                                                   |
|                  |        |                                                                                                     |
| 氏名             | 256    | A                                                                                                   |
|                  |        |                                                                                                     |
| 法人名           | 64     | A                                                                                                   |
|                  |        |                                                                                                     |
| メールアドレス   | 254    | RFC 2821                                                                                            |
|                  |        | 区切り文字（ `<` `>` を含めて256文字が上限）                                                        |
|                  | 320    | RFC 3696、RFC 5321                                                                                  |
|                  |        | ローカル部（@より前）の最大長は64文字                                                               |
|                  |        | ドメイン部（@より後）の最大長は255文字                                                              |
|                  |        | ただし、DNSで名前解決をする必要があるため、DNS側の仕様による制約を受け、ドメイン部の最大長は253文字 |
|                  |        |                                                                                                     |
| 電話番号         |        | ITU-T(国際電気通信連合 電気通信標準化セクター) E.164勧告                                            |
|                  | 19     | （国番号含め最大15桁 + `+` + `-` 3 つ）                                                             |
|                  | 15     | （国番号含め最大15桁）                                                                              |
|                  |        |                                                                                                     |
| 郵便番号（日本） | 7      | ハイフン無                                                                                          |
|                  | 8      | ハイフン有                                                                                          |
|                  |        |                                                                                                     |
| 住所             | 1408   | country（128） + state（128） + city（128） + streetAddress（1024）                                 |
|                  |        |                                                                                                     |
| URL              | 8000   | RFC 7230                                                                                            |
|                  |        |                                                                                                     |

#### コード定義

コード値が規格で定められているものについては、それを使用する。

| 項目                              | コード  | 意味            | 根拠                                          |
| --------------------------------- | ------- | --------------- | --------------------------------------------- |
| 生物学的性別（GenderではなくSex） |         |                 | ISO 5218                                      |
|                                   | `0`     | not known       |                                               |
|                                   | `1`     | male            |                                               |
|                                   | `2`     | female          |                                               |
|                                   | `9`     | not applicable  |                                               |
|                                   |         |                 |                                               |
| 国（国名コード）                  |         |                 | ISO 3166-1                                    |
|                                   | `392`   | 日本（numeric） |                                               |
|                                   | `JPN`   | 日本（alpha-3） |                                               |
|                                   | `JP`    | 日本（alpha-2） |                                               |
|                                   |         |                 |                                               |
| 言語（言語コード）                |         |                 |                                               |
|                                   | `ja`    | 日本語          | ISO 639                                       |
|                                   | `ja-JP` | 日本語 (日本)   | IETF言語タグ IETF BCP47（RFC 5646、RFC 4647） |
|                                   |         |                 |                                               |
| 都道府県・市区町村                |         |                 | 全国地方公共団体コード（JIS X 0401）          |
|                                   |         |                 |                                               |

#### コード以外の定義

| 項目         | 内容 | 根拠 |
| ------------ | ---- | ---- |
| 郵便番号     |      |      |
|              |      |      |
| 電話番号     |      |      |
| （固定電話） |      |      |
| （携帯電話） |      |      |
|              |      |      |
|              |      |      |
|              |      |      |
|              |      |      |
|              |      |      |
|              |      |      |
|              |      |      |


### 列名

| データ型 | 内容                                           | x               | o             |
| -------- | ---------------------------------------------- | --------------- | ------------- |
| Boolean  | True / Falseがどちらの状態を表すのか明確にする | `delete_flag`   | `is_deleted`  |
| Date     | 過去分詞_on                                    | `creation_date` | `created_on`  |
| DateTime | 過去分詞_at                                    |                 | `updated_on`  |
| Time     | 過去分詞_at                                    |                 | `modified_on` |
|          |                                                |                 |               |

### 列持ち→行持ち

列を増減させることが難しく、アプリケーション側で都度NULLチェックする必要があるため、列持ち（横持ち）は避けて行持ち（縦持ち）の構造としたほうが良い。

| 社員 | 資格1        | 資格2                      | 資格3    |
| ---- | ------------ | -------------------------- | -------- |
| 江崎 | ITパスポート | 基本情報                   | 応用情報 |
| 望月 | 基本情報     | クラウドプラクティショナー |          |
|      |              |                            |          |

　　　↓

| 社員 | 資格コード |
| ---- | ---------- |
| 江崎 | 001        |
| 江崎 | 002        |
| 江崎 | 003        |
| 望月 | 002        |
| 望月 | 100        |
|      |            |

| 資格コード | 資格名                     |
| ---------- | -------------------------- |
| 001        | ITパスポート               |
| 002        | 基本情報                   |
| 003        | 応用情報                   |
| 100        | クラウドプラクティショナー |
|            |                            |

### Entity Attribute Value

データ型やサイズなどの制約チェックができないので、列持ち（横持ち）に直すか、テーブルを分割する。テーブルを分割する際に、都道府県マスタと市区町村マスタのように、ほぼ共通の列で一部だけ異なる列が含まれるような組み合わせの場合は、2テーブルではなく、継承元のテーブル1つ＋継承先のテーブル2つとすることも可能。

| マスタ種別 | 設定キー       | 設定値                        |
| ---------- | -------------- | ----------------------------- |
| 顧客マスタ | 顧客コード     | 001                           |
| 顧客マスタ | 顧客名         | コントソ株式会社              |
| 顧客マスタ | 連絡先電話番号 | 03-0123-4567                  |
| 顧客マスタ | URL            | https://contoso.example.net/  |
| 顧客マスタ | 顧客コード     | 002                           |
| 顧客マスタ | 顧客名         | 株式会社ファブリカム          |
| 顧客マスタ | 連絡先電話番号 | 0120-000-000                  |
| 顧客マスタ | URL            | https://fabrikam.example.net/ |
| ...        |                |                               |
| 役職マスタ | 役職コード     | 001                           |
| 役職マスタ | 役職名         | 社長                          |
| 役職マスタ | 上位役職コード | NULL                          |
| 役職マスタ | 役職コード     | 002                           |
| 役職マスタ | 役職名         | 副社長                        |
| 役職マスタ | 上位役職コード | 001                           |
| ...        |                |                               |
|            |                |                               |

　　　↓

| マスタ種別 | 顧客コード | 顧客名               | 連絡先電話番号 | URL                           | 役職コード | 役職名 | 上位役職コード |
| ---------- | ---------- | -------------------- | -------------- | ----------------------------- | ---------- | ------ | -------------- |
| 顧客マスタ | 001        | コントソ株式会社     | 03-0123-4567   | ttps://contoso.example.net/   | NULL       | NULL   | NULL           |
| 顧客マスタ | 002        | 株式会社ファブリカム | 0120-000-000   | https://fabrikam.example.net/ | NULL       | NULL   | NULL           |
| ...        |            |                      |                |                               |            |        |                |
| 役職マスタ | NULL       | NULL                 | NULL           | NULL                          | 001        | 社長   | NULL           |
| 役職マスタ | NULL       | NULL                 | NULL           | NULL                          | 002        | 副社長 | 001            |
| ...        |            |                      |                |                               |            |        |                |

　　　↓

| 顧客コード | 顧客名               | 連絡先電話番号 | URL                           |
| ---------- | -------------------- | -------------- | ----------------------------- |
| 001        | コントソ株式会社     | 03-0123-4567   | ttps://contoso.example.net/   |
| 002        | 株式会社ファブリカム | 0120-000-000   | https://fabrikam.example.net/ |
| ...        |                      |                |                               |

| 役職コード | 役職名 | 上位役職コード |
| ---------- | ------ | -------------- |
| 001        | 社長   | NULL           |
| 002        | 副社長 | 001            |
| ...        |        |                |


---

Copyright (c) 2023 YA-androidapp(https://github.com/yzkn) All rights reserved.
